<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Ticket</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif; 
      min-height: 100vh;
      background: url('/background.jpg') center/cover no-repeat fixed;
      position: relative;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('/background.jpg') center/cover no-repeat;
      filter: blur(8px);
      z-index: -1;
    }
    .container {
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    .status-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .status-pending {
      background: rgba(255, 237, 213, 0.95);
      color: #92400e;
    }
    .status-confirmed {
      background: rgba(236, 253, 245, 0.95);
      color: #065f46;
    }
    .status-rejected {
      background: rgba(254, 242, 242, 0.95);
      color: #991b1b;
    }
    .ticket-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    .ticket-image {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .ticket-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .ticket-number {
      position: absolute;
      bottom: 45px;
      right: 50px;
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
      letter-spacing: 3px;
      font-family: 'Arial', sans-serif;
    }
    .ticket-name {
      position: absolute;
      bottom: 120px;
      left: 60px;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .ticket-userid {
      position: absolute;
      bottom: 100px;
      left: 60px;
      font-size: 16px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .loading {
      color: #fff;
      font-size: 18px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .action-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.9);
      color: #2563eb;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
      font-family: Arial, sans-serif;
    }
    .action-btn:hover {
      background: rgba(255, 255, 255, 1);
    }
    @media (max-width: 768px) {
      .ticket-number {
        bottom: 35px;
        right: 25px;
        font-size: 20px;
        letter-spacing: 2px;
      }
      .ticket-name {
        bottom: 100px;
        left: 30px;
        font-size: 16px;
      }
      .ticket-userid {
        bottom: 80px;
        left: 30px;
        font-size: 14px;
      }
    }
  </style>
  <script>
    let currentTicket = null;
    let ticketTemplatePromise;

    async function loadTicket() {
      const urlParams = new URLSearchParams(window.location.search);
      const ticketId = urlParams.get('id');
      
      if (!ticketId) {
        document.body.innerHTML = '<div class="container"><div class="status-card status-rejected"><h2>Error</h2><p>No ticket ID provided.</p><a href="/" class="action-btn">Go Back</a></div></div>';
        return;
      }

      try {
        const res = await fetch('/api/ticket/' + encodeURIComponent(ticketId));
        const ticket = await res.json();
        
        if (!res.ok) {
          throw new Error(ticket.message || 'Failed to load ticket');
        }

        const container = document.getElementById('ticketContainer');
        const statusCard = document.getElementById('statusCard');
        
        // Update status card
        statusCard.className = 'status-card status-' + ticket.status;
        const downloadBtn = document.getElementById('downloadBtn');

        if (ticket.status === 'pending') {
          statusCard.innerHTML = '<h2>⏳ Pending Approval</h2><p>Your ticket is waiting for admin approval. Please wait a few minutes and refresh this page.</p>';
        } else if (ticket.status === 'confirmed') {
          statusCard.innerHTML = '<h2>✅ Ticket Approved!</h2><p>Your ticket has been confirmed. See your ticket below.</p>';
        } else if (ticket.status === 'rejected') {
          statusCard.innerHTML = '<h2>❌ Ticket Rejected</h2><p>Your ticket submission was rejected. Please contact support if you believe this is an error.</p>';
        }

        // Show ticket image with details if confirmed
        if (ticket.status === 'confirmed' && ticket.ticketNumber) {
          container.innerHTML = `
            <div class="ticket-container">
              <img src="/ticket.png" alt="Ticket" class="ticket-image" />
              <div class="ticket-overlay">
                <div class="ticket-number">${escapeHtml(ticket.ticketNumber)}</div>
                <div class="ticket-name">${escapeHtml(ticket.name)}</div>
                <div class="ticket-userid">ID: ${escapeHtml(ticket.userId)}</div>
              </div>
            </div>
          `;
          currentTicket = {
            ticketNumber: ticket.ticketNumber,
            name: ticket.name,
            userId: ticket.userId
          };
          if (downloadBtn) downloadBtn.style.display = 'inline-block';
        } else {
          container.innerHTML = '<div class="loading">Ticket details will appear here once approved.</div>';
          currentTicket = null;
          if (downloadBtn) downloadBtn.style.display = 'none';
        }

        // Auto-refresh if pending
        if (ticket.status === 'pending') {
          setTimeout(() => {
            loadTicket();
          }, 30000); // Refresh every 30 seconds
        }
      } catch (e) {
        document.body.innerHTML = '<div class="container"><div class="status-card status-rejected"><h2>Error</h2><p>' + escapeHtml(e.message) + '</p><a href="/" class="action-btn">Go Back</a></div></div>';
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function loadTicketTemplate() {
      if (!ticketTemplatePromise) {
        ticketTemplatePromise = new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = '/ticket.png';
        });
      }
      return ticketTemplatePromise;
    }

    async function buildTicketImage(ticket) {
      const template = await loadTicketTemplate();
      const canvas = document.createElement('canvas');
      canvas.width = template.width;
      canvas.height = template.height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(template, 0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#ffffff';
      ctx.textBaseline = 'alphabetic';
      ctx.shadowColor = 'rgba(0,0,0,0.85)';
      ctx.shadowBlur = 6;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;

      // Ticket number (bottom right "TICKET NO")
      ctx.textAlign = 'right';
      ctx.font = `700 ${Math.round(canvas.width * 0.045)}px Arial`;
      ctx.fillText(ticket.ticketNumber || '', canvas.width * 0.88, canvas.height * 0.86);

      // Name (left area above price block)
      ctx.textAlign = 'left';
      ctx.font = `700 ${Math.round(canvas.width * 0.038)}px Arial`;
      ctx.fillText((ticket.name || '').toUpperCase(), canvas.width * 0.12, canvas.height * 0.78);

      // ID below name
      ctx.font = `600 ${Math.round(canvas.width * 0.032)}px Arial`;
      ctx.fillText(`ID: ${ticket.userId || ''}`, canvas.width * 0.12, canvas.height * 0.83);

      return canvas.toDataURL('image/png');
    }

    async function downloadCurrentTicket() {
      if (!currentTicket) {
        alert('Ticket will be available for download after approval.');
        return;
      }
      try {
        const dataUrl = await buildTicketImage(currentTicket);
        const link = document.createElement('a');
        const safeNumber = (currentTicket.ticketNumber || 'ticket').toString().replace(/[^a-z0-9_-]/gi, '');
        link.href = dataUrl;
        link.download = `ticket-${safeNumber || 'download'}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        console.error('Download failed:', err);
        alert('Failed to download ticket. Please try again.');
      }
    }

    window.addEventListener('DOMContentLoaded', loadTicket);
  </script>
</head>
<body>
  <div class="container">
    <div id="statusCard" class="status-card">
      <div class="loading">Loading ticket...</div>
    </div>
    <div id="ticketContainer"></div>
    <div class="actions">
      <button onclick="window.location.reload()" class="action-btn">Reload Page</button>
      <button id="downloadBtn" onclick="downloadCurrentTicket()" class="action-btn" style="display: none;">Download Ticket</button>
    </div>
  </div>
</body>
</html>

